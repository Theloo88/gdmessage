<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Supabase Chat</title>

<style>
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
    background: #0f0f0f;
    color: white;
    font-family: Inter, Arial, sans-serif;
  }

  #statusBar {
    width: 100%;
    text-align: center;
    padding: 10px;
    font-weight: 600;
    background: #151515;
    border-bottom: 1px solid #0b0b0b;
  }

  #messages {
    height: calc(100vh - 210px);
    overflow-y: auto;
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    scroll-behavior: smooth;
  }

  .msg {
    max-width: 72%;
    padding: 40px 16px 12px 16px; /* extra top padding for actions */
    border-radius: 12px;
    line-height: 1.35;
    word-wrap: break-word;
    position: relative;
    overflow: visible;
    box-shadow: 0 1px 0 rgba(255,255,255,0.02) inset;
  }

  .me {
    align-self: flex-end;
    background: linear-gradient(180deg,#67ABF1,#4f93d6);
    color: #041726;
  }

  .other {
    align-self: flex-start;
    background: linear-gradient(180deg,#2b2b2b,#262626);
    color: #eaeaea;
  }

  .msg-username {
    font-size: 13px;
    opacity: 0.85;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .msg-text {
    font-size: 15.5px;
    white-space: pre-wrap;
  }

  .msg-time {
    font-size: 12px;
    opacity: 0.6;
    margin-top: 8px;
    text-align: right;
  }

  .msg-reply-preview {
    font-size: 12px;
    opacity: 0.95;
    background: rgba(0,0,0,0.18);
    border-radius: 8px;
    padding: 6px 10px;
    margin-bottom: 8px;
    color: #f1f1f1;
  }

  .msg-actions {
    position: absolute;
    top: 4px;
    right: 8px;
    display: flex;
    flex-direction: row;
    gap: 6px;
    opacity: 0;
    transition: opacity 0.18s ease;
    pointer-events: none;
    z-index: 5;
  }

  .msg:hover .msg-actions {
    opacity: 1;
    pointer-events: auto;
  }

  .msg-action-btn {
    background: rgba(0,0,0,0.35);
    border: none;
    color: white;
    padding: 4px 6px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .msg-action-btn:hover {
    background: rgba(255,255,255,0.06);
  }

  .msg-reply-btn {
    margin-top: 6px;
    font-size: 14px;
    opacity: 0.85;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .me-reply {
    color: #003a6b;
  }

  .other-reply {
    color: #bdbdbd;
  }

  .reactions-row {
    display: none;
    margin-top: 8px;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
    z-index: 4;
    pointer-events: auto;
  }

  .msg:hover .reactions-row {
    display: flex;
  }

  .reaction-bubble {
    background: rgba(0,0,0,0.22);
    border-radius: 999px;
    padding: 4px 8px;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    user-select: none;
    pointer-events: auto;
    z-index: 6;
  }

  .reaction-bubble.me-reacted {
    background: rgba(255,255,255,0.22);
    font-weight: 700;
  }

  .reaction-plus {
    background: rgba(255,255,255,0.04);
    border-radius: 999px;
    padding: 4px 8px;
    font-size: 14px;
    cursor: pointer;
    user-select: none;
    pointer-events: auto;
    z-index: 6;
  }

  #emojiPicker {
    display:none;
    position:fixed;
    bottom:110px;
    left:50%;
    transform:translateX(-50%);
    background:#1e1e1e;
    padding:10px;
    border-radius:10px;
    border:1px solid #2b2b2b;
    z-index:9999;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  }

  #emojiPickerList {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    font-size:22px;
    max-width: 420px;
    max-height: 220px;
    overflow: auto;
    padding: 6px;
  }

  #inputArea {
    display: flex;
    flex-direction: column;
    padding: 12px;
    background: #151515;
    gap: 10px;
    border-top: 1px solid #0b0b0b;
  }

  #replyBar {
    display: none;
    background: #232323;
    border-radius: 8px;
    padding: 8px 10px;
    font-size: 13px;
    align-items: center;
    justify-content: space-between;
    display: flex;
  }

  #replyBarText {
    color: #eaeaea;
    opacity: 0.95;
    font-size: 13px;
  }

  #replyCancel {
    cursor: pointer;
    opacity: 0.85;
    padding: 4px 8px;
    border-radius: 6px;
    background: rgba(255,255,255,0.02);
  }

  #inputRow {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  #message {
    flex: 1;
    padding: 12px;
    border-radius: 20px;
    border: none;
    font-size: 15px;
    background: #0f0f0f;
    color: #fff;
    outline: none;
  }

  #send {
    width: 56px;
    height: 56px;
    background: #67ABF1;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    box-shadow: 0 6px 18px rgba(103,171,241,0.12);
  }

  #send::before {
    content: "";
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-40%, -50%) rotate(90deg);
    width: 0;
    height: 0;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-left: 16px solid white;
  }

  #namePopup {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #nameBox {
    background: #1e1e1e;
    padding: 26px;
    border-radius: 10px;
    text-align: center;
    width: 360px;
  }

  #nameInput {
    width: 100%;
    padding: 12px;
    border-radius: 6px;
    border: none;
    margin-top: 10px;
    background: #0f0f0f;
    color: #fff;
  }

  #startBtn {
    margin-top: 14px;
    padding: 10px 20px;
    background: #67ABF1;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  }

  /* Edit popup */
  #editPopup {
    display:none;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background:#1e1e1e;
    padding:20px;
    border-radius:10px;
    border:1px solid #333;
    z-index:9999;
    width:300px;
  }

  #editInput {
    width:100%;
    height:80px;
    background:#0f0f0f;
    color:white;
    border:none;
    border-radius:6px;
    padding:8px;
    resize:none;
  }

  #editButtons {
    margin-top:10px;
    display:flex;
    justify-content:space-between;
  }

  #editCancel, #editSave {
    padding:6px 12px;
    border-radius:6px;
    border:none;
    cursor:pointer;
  }

  #editSave {
    background:#67ABF1;
  }

  /* small screens */
  @media (max-width: 640px) {
    .msg { max-width: 92%; }
    #emojiPicker { left: 50%; bottom: 140px; transform: translateX(-50%); }
  }
</style>
</head>

<body>

<div id="statusBar">üî¥ DISCONNECTED</div>

<div id="namePopup">
  <div id="nameBox">
    <h2 style="margin:0 0 8px 0;">Enter your name</h2>
    <input id="nameInput" placeholder="Your name">
    <button id="startBtn">Join</button>
  </div>
</div>

<div id="messages" aria-live="polite"></div>

<div id="emojiPicker" aria-hidden="true">
  <div id="emojiPickerList" role="list"></div>
</div>

<div id="editPopup">
  <h3 style="margin-top:0;">Edit Message</h3>
  <textarea id="editInput"></textarea>
  <div id="editButtons">
    <button id="editCancel">Cancel</button>
    <button id="editSave">Save</button>
  </div>
</div>

<div id="inputArea">
  <div id="replyBar" role="region" aria-label="Reply preview">
    <div id="replyBarText"></div>
    <div id="replyCancel" title="Cancel reply">‚úï</div>
  </div>

  <div id="inputRow">
    <input id="message" placeholder="Message" autocomplete="off" />
    <button id="send" aria-label="Send message"></button>
  </div>
</div><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
window.onload = async () => {

  /* ------------------------------
     SUPABASE SETUP
  ------------------------------ */
  const SUPABASE_URL = "https://qfluprievxnfqjqfqvxk.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmbHVwcmlldnhuZnFqcWZxdnhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MDA3NjksImV4cCI6MjA4NTE3Njc2OX0.pqRbMRZciADFGtmpDSP7aG7turUASnb6SqqVTQXntWY";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ------------------------------
     DOM ELEMENTS
  ------------------------------ */
  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("message");
  const sendBtn = document.getElementById("send");
  const statusBar = document.getElementById("statusBar");

  const replyBar = document.getElementById("replyBar");
  const replyBarText = document.getElementById("replyBarText");
  const replyCancel = document.getElementById("replyCancel");

  const emojiPicker = document.getElementById("emojiPicker");
  const emojiPickerList = document.getElementById("emojiPickerList");

  const editPopup = document.getElementById("editPopup");
  const editInput = document.getElementById("editInput");
  const editCancel = document.getElementById("editCancel");
  const editSave = document.getElementById("editSave");

  /* ------------------------------
     STATE
  ------------------------------ */
  let username = "";
  let replyTarget = null; // { id, username, text }
  let emojiPickerTarget = null; // message_id (string)
  let editingMessage = null;

  const DEFAULT_REACTIONS = ["ü§£","üòÄ","üò≠","üëç","üëé","üíå"];

  // Maps (keys are strings to avoid type mismatch)
  const messageElements = new Map();     // idString -> DOM element
  const messagesById = new Map();        // idString -> message object
  const reactionsByMessage = new Map();  // idString -> array of reaction rows

  /* ------------------------------
     JOIN POPUP
  ------------------------------ */
  messageInput.disabled = true;
  sendBtn.disabled = true;

  document.getElementById("startBtn").onclick = () => {
    const name = document.getElementById("nameInput").value.trim();
    if (!name) return;

    username = name;
    document.getElementById("namePopup").style.display = "none";

    messageInput.disabled = false;
    sendBtn.disabled = false;
    messageInput.focus();
  };

  replyCancel.onclick = () => {
    replyTarget = null;
    replyBar.style.display = "none";
  };

  /* ------------------------------
     EMOJI PICKER LIST (populate)
  ------------------------------ */
  const EXTRA_EMOJIS = [
    "üòÑ","üòÜ","üòä","üòç","üòÖ","ü§î","üòÆ","üò¥","üò°","üëè","üôè",
    "üî•","üéâ","ü§ù","üíØ","ü§©","üòé","ü§Ø","üò¨","ü§ó"
  ];

  function populateEmojiPicker() {
    emojiPickerList.innerHTML = "";
    const base = [...DEFAULT_REACTIONS, ...EXTRA_EMOJIS];
    base.forEach(e => {
      const span = document.createElement("div");
      span.textContent = e;
      span.style.cursor = "pointer";
      span.style.padding = "6px";
      span.style.borderRadius = "6px";
      span.style.userSelect = "none";
      span.setAttribute("role","button");
      emojiPickerList.appendChild(span);
    });
  }
  populateEmojiPicker();

  /* ------------------------------
     LOAD EXISTING MESSAGES
  ------------------------------ */
  const { data: existingMessages } = await client
    .from("messages")
    .select("*")
    .order("created_at", { ascending: true });

  if (existingMessages) {
    existingMessages.forEach(m => messagesById.set(String(m.id), m));
  }

  /* ------------------------------
     LOAD EXISTING REACTIONS
  ------------------------------ */
  const { data: existingReactions } = await client
    .from("reactions")
    .select("*")
    .order("created_at", { ascending: true });

  if (existingReactions) {
    existingReactions.forEach(r => {
      const key = String(r.message_id);
      if (!reactionsByMessage.has(key)) {
        reactionsByMessage.set(key, []);
      }
      reactionsByMessage.get(key).push(r);
    });
  }

  /* ------------------------------
     RENDER ALL EXISTING MESSAGES
  ------------------------------ */
  if (existingMessages) {
    existingMessages.forEach(addOrUpdateMessageElement);
  }

  /* ------------------------------
     REALTIME: MESSAGES
  ------------------------------ */
  client
    .channel("chat-messages")
    .on(
      "postgres_changes",
      { event: "INSERT", schema: "public", table: "messages" },
      payload => {
        const msg = payload.new;
        const idStr = String(msg.id);
        messagesById.set(idStr, msg);
        addOrUpdateMessageElement(msg);

        // If this message is a reply to another that we already have, re-render original
        if (msg.reply_to && messagesById.has(String(msg.reply_to))) {
          addOrUpdateMessageElement(messagesById.get(String(msg.reply_to)));
        }
      }
    )
    .on(
      "postgres_changes",
      { event: "UPDATE", schema: "public", table: "messages" },
      payload => {
        const msg = payload.new;
        const idStr = String(msg.id);
        messagesById.set(idStr, msg);
        addOrUpdateMessageElement(msg);
      }
    )
    .on(
      "postgres_changes",
      { event: "DELETE", schema: "public", table: "messages" },
      payload => {
        const msg = payload.old;
        const idStr = String(msg.id);
        messagesById.delete(idStr);

        const el = messageElements.get(idStr);
        if (el && el.parentNode) el.parentNode.removeChild(el);

        messageElements.delete(idStr);
        reactionsByMessage.delete(idStr);
      }
    )
    .subscribe();

  /* ------------------------------
     REALTIME: REACTIONS
  ------------------------------ */
  client
    .channel("chat-reactions")
    .on(
      "postgres_changes",
      { event: "INSERT", schema: "public", table: "reactions" },
      payload => {
        const r = payload.new;
        const key = String(r.message_id);
        if (!reactionsByMessage.has(key)) {
          reactionsByMessage.set(key, []);
        }
        reactionsByMessage.get(key).push(r);
        refreshReactionsForMessage(key);
      }
    )
    .on(
      "postgres_changes",
      { event: "UPDATE", schema: "public", table: "reactions" },
      payload => {
        const r = payload.new;
        const key = String(r.message_id);
        const arr = reactionsByMessage.get(key) || [];
        const idx = arr.findIndex(x => x.id === r.id);
        if (idx !== -1) arr[idx] = r;
        else arr.push(r);
        reactionsByMessage.set(key, arr);
        refreshReactionsForMessage(key);
      }
    )
    .on(
      "postgres_changes",
      { event: "DELETE", schema: "public", table: "reactions" },
      payload => {
        const r = payload.old;
        const key = String(r.message_id);
        const arr = reactionsByMessage.get(key) || [];
        const filtered = arr.filter(x => x.id !== r.id);
        reactionsByMessage.set(key, filtered);
        refreshReactionsForMessage(key);
      }
    )
    .subscribe();

  /* ------------------------------
     CLOSE EMOJI PICKER WHEN CLICKING OUTSIDE
  ------------------------------ */
  document.addEventListener("click", (e) => {
    if (!emojiPicker) return;
    if (emojiPicker.style.display === "none") return;
    const path = e.composedPath ? e.composedPath() : (e.path || []);
    if (!path.includes(emojiPicker)) {
      emojiPicker.style.display = "none";
      emojiPickerTarget = null;
      emojiPicker.setAttribute("aria-hidden","true");
    }
  });  /* ----------------------------------------------------
     RENDER / UPDATE MESSAGE ELEMENT
  ---------------------------------------------------- */
  function addOrUpdateMessageElement(msg) {
    const idStr = String(msg.id);

    // Ensure message is stored
    if (!messagesById.has(idStr)) messagesById.set(idStr, msg);

    let div = messageElements.get(idStr);
    const isMe = msg.username === username;

    if (!div) {
      div = document.createElement("div");
      div.classList.add("msg");
      div.dataset.id = idStr;
      messageElements.set(idStr, div);
      messagesDiv.appendChild(div);
    }

    div.className = "msg " + (isMe ? "me" : "other");

    const time = msg.created_at
      ? new Date(msg.created_at).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit"
        })
      : "";

    /* ------------------------------
       REPLY PREVIEW
    ------------------------------ */
    let replyPreviewHtml = "";
    if (msg.reply_to) {
      const original = messagesById.get(String(msg.reply_to));

      if (original) {
        const snippet = (original.text || "").slice(0, 40);
        replyPreviewHtml = `
          <div class="msg-reply-preview">
            Replying to ${escapeHtml(original.username)}:
            ‚Äú${escapeHtml(snippet)}${(original.text || "").length > 40 ? "..." : ""}‚Äù
          </div>
        `;
      } else {
        // Placeholder while fetching
        replyPreviewHtml = `
          <div class="msg-reply-preview">
            Replying to message‚Ä¶
          </div>
        `;

        // Fetch original if missing
        client
          .from("messages")
          .select("*")
          .eq("id", msg.reply_to)
          .limit(1)
          .then(res => {
            if (res.data && res.data[0]) {
              messagesById.set(String(res.data[0].id), res.data[0]);
              addOrUpdateMessageElement(res.data[0]);
              addOrUpdateMessageElement(msg);
            }
          });
      }
    }

    /* ------------------------------
       MESSAGE BUBBLE HTML
    ------------------------------ */
    div.innerHTML = `
      ${replyPreviewHtml}
      <div class="msg-username">${escapeHtml(msg.username)}</div>
      <div class="msg-text">${escapeHtml(msg.text)}</div>
      <div class="msg-time">${time}</div>

      <div class="msg-reply-btn ${isMe ? "me-reply" : "other-reply"}">
        ‚Ü∞ Reply
      </div>

      <div class="reactions-row"></div>
    `;

    /* ------------------------------
       INLINE ACTIONS (EDIT / DELETE / REPLY)
    ------------------------------ */
    const actions = document.createElement("div");
    actions.classList.add("msg-actions");

    // EDIT (only for me)
    if (isMe) {
      const editBtn = document.createElement("button");
      editBtn.classList.add("msg-action-btn");
      editBtn.textContent = "‚úèÔ∏è";
      editBtn.onclick = e => {
        e.stopPropagation();
        openEditPopup(msg);
      };
      actions.appendChild(editBtn);

      const deleteBtn = document.createElement("button");
      deleteBtn.classList.add("msg-action-btn");
      deleteBtn.textContent = "üóëÔ∏è";
      deleteBtn.onclick = e => {
        e.stopPropagation();
        deleteMessage(msg);
      };
      actions.appendChild(deleteBtn);
    }

    // REPLY (everyone)
    const replyBtnSmall = document.createElement("button");
    replyBtnSmall.classList.add("msg-action-btn");
    replyBtnSmall.textContent = "‚Ü∞";
    replyBtnSmall.onclick = e => {
      e.stopPropagation();
      startReply(msg);
    };
    actions.appendChild(replyBtnSmall);

    div.appendChild(actions);

    /* ------------------------------
       REPLY BUTTON UNDER BUBBLE
    ------------------------------ */
    div.querySelector(".msg-reply-btn").onclick = e => {
      e.stopPropagation();
      startReply(msg);
    };

    /* ------------------------------
       RENDER REACTIONS
    ------------------------------ */
    refreshReactionsForMessage(idStr);

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  /* ----------------------------------------------------
     START REPLY
  ---------------------------------------------------- */
  function startReply(msg) {
    replyTarget = {
      id: msg.id,
      username: msg.username,
      text: msg.text
    };

    const snippet = (msg.text || "").slice(0, 40);
    replyBarText.textContent =
      `Replying to ${msg.username}: ‚Äú${snippet}${msg.text.length > 40 ? "..." : ""}‚Äù`;

    replyBar.style.display = "flex";
    messageInput.focus();
  }

  /* ----------------------------------------------------
     RENDER REACTIONS FOR A MESSAGE
  ---------------------------------------------------- */
  function refreshReactionsForMessage(messageIdStr) {
    const div = messageElements.get(messageIdStr);
    if (!div) return;

    const row = div.querySelector(".reactions-row");
    if (!row) return;

    row.innerHTML = "";

    const allReacts = reactionsByMessage.get(messageIdStr) || [];

    /* Group by emoji */
    const grouped = {};
    allReacts.forEach(r => {
      if (!grouped[r.emoji]) grouped[r.emoji] = [];
      grouped[r.emoji].push(r);
    });

    /* Render each emoji bubble */
    Object.keys(grouped).forEach(emoji => {
      const users = grouped[emoji];
      const count = users.length;
      const meReacted = users.some(u => u.username === username);

      const bubble = document.createElement("div");
      bubble.classList.add("reaction-bubble");
      if (meReacted) bubble.classList.add("me-reacted");

      bubble.textContent = `${emoji} ${count}`;
      bubble.onclick = e => {
        e.stopPropagation();
        toggleReaction(messageIdStr, emoji);
      };

      row.appendChild(bubble);
    });

    /* + button */
    const plus = document.createElement("div");
    plus.classList.add("reaction-plus");
    plus.textContent = "+";
    plus.onclick = e => {
      e.stopPropagation();
      openEmojiPicker(messageIdStr);
    };
    row.appendChild(plus);

    /* Default quick reactions if none exist */
    if (allReacts.length === 0) {
      DEFAULT_REACTIONS.forEach(emoji => {
        const bubble = document.createElement("div");
        bubble.classList.add("reaction-bubble");
        bubble.textContent = emoji;
        bubble.onclick = e => {
          e.stopPropagation();
          toggleReaction(messageIdStr, emoji);
        };
        row.appendChild(bubble);
      });
    }
  }

  /* ----------------------------------------------------
     OPEN EMOJI PICKER
  ---------------------------------------------------- */
  function openEmojiPicker(messageIdStr) {
    emojiPickerTarget = messageIdStr;
    emojiPicker.style.display = "block";
    emojiPicker.setAttribute("aria-hidden", "false");
  }

  emojiPickerList.onclick = async e => {
    const emoji = e.target.textContent.trim();
    if (!emoji || !emojiPickerTarget) return;

    await toggleReaction(emojiPickerTarget, emoji);

    emojiPicker.style.display = "none";
    emojiPickerTarget = null;
    emojiPicker.setAttribute("aria-hidden", "true");
  };

  /* ----------------------------------------------------
     TOGGLE REACTION
  ---------------------------------------------------- */
  async function toggleReaction(messageIdStr, emoji) {
    if (!username) return;

    const key = String(messageIdStr);
    const arr = reactionsByMessage.get(key) || [];
    const existing = arr.find(r => r.username === username);

    try {
      if (existing && existing.emoji === emoji) {
        await client.from("reactions").delete().eq("id", existing.id);
      } else if (existing) {
        await client.from("reactions").update({ emoji }).eq("id", existing.id);
      } else {
        await client.from("reactions").insert({
          message_id: Number(key),
          username,
          emoji
        });
      }
    } catch (err) {
      console.error("Reaction error:", err);
    }
  }  /* ----------------------------------------------------
     OPEN EDIT POPUP
  ---------------------------------------------------- */
  function openEditPopup(msg) {
    editingMessage = msg;
    editInput.value = msg.text;
    editPopup.style.display = "block";
  }

  editCancel.onclick = () => {
    editingMessage = null;
    editPopup.style.display = "none";
  };

  editSave.onclick = async () => {
    if (!editingMessage) return;

    const newText = editInput.value.trim();
    if (!newText) return;

    try {
      await client
        .from("messages")
        .update({ text: newText })
        .eq("id", editingMessage.id);

      editPopup.style.display = "none";
      editingMessage = null;
    } catch (err) {
      console.error("Edit error:", err);
    }
  };

  /* ----------------------------------------------------
     DELETE MESSAGE
  ---------------------------------------------------- */
  async function deleteMessage(msg) {
    const ok = confirm("Delete this message?");
    if (!ok) return;

    try {
      await client.from("messages").delete().eq("id", msg.id);
    } catch (err) {
      console.error("Delete error:", err);
    }
  }

  /* ----------------------------------------------------
     SEND MESSAGE
  ---------------------------------------------------- */
  sendBtn.onclick = async () => {
    const text = messageInput.value.trim();
    if (!text || !username) return;

    const payload = {
      username,
      text,
      created_at: new Date().toISOString()
    };

    if (replyTarget) {
      payload.reply_to = replyTarget.id;
    }

    try {
      await client.from("messages").insert(payload);
      messageInput.value = "";
      replyTarget = null;
      replyBar.style.display = "none";
    } catch (err) {
      console.error("Send error:", err);
    }
  };

  messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  /* ----------------------------------------------------
     CONNECTION CHECKER
  ---------------------------------------------------- */
  async function checkConnection() {
    try {
      await client.from("messages").select("id").limit(1);
      statusBar.textContent = "üü¢ CONNECTED";
    } catch {
      statusBar.textContent = "üî¥ DISCONNECTED";
    }
  }
  setInterval(checkConnection, 2000);

  /* ----------------------------------------------------
     UTILS
  ---------------------------------------------------- */
  function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return "";
    return String(unsafe)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

}; // END window.onload
</script>

</body>
</html>
